#!/bin/bash
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: 2019 Free Software Foundation Europe e.V.

REPO="${1}"
REUSE_OPT_GLOBAL="${2}"
REUSE_OPT_LINT="${3}"
TMP="$(mktemp)"

# Test if repo URL provided
if [[ -z ${REPO} ]]; then
  echo "No repo URL provided"
  exit 41
fi
# Test if API worker runner image exists
if [[ "$(docker images -q reuse-api-worker-runner 2> /dev/null)" == "" ]]; then
  echo "reuse-api-worker-runner Docker image does not exist."
  exit 42
fi

# Create ENV file containing REUSE args
echo "REUSE_OPT_GLOBAL=${REUSE_OPT_GLOBAL}" > $TMP
echo "REUSE_OPT_LINT=${REUSE_OPT_LINT}" >> $TMP

# Extract name for docker container
DNAME="$(basename "$(dirname "${REPO}")")__$(basename "${REPO}")__$(echo ${REPO} | xxh32sum | awk '{print $1}'  )"

# Run docker image and return status
docker run --env-file $TMP --name "${DNAME}" --rm reuse-api-worker-runner "${REPO}"
status=$?

rm $TMP

exit $status
